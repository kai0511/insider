---
title: "GTEx data analysis"
author: "ZHAO Kai"
header-includes:
  - \usepackage[mono=false]{libertine}
fontsize: 10pt
output: pdf_document
mainfont: libertine
sansfont: libertine
---

Here is a brief introduction of analyzing the results of our proposed approach on [GTEx](https://https://www.gtexportal.org). In this analysis, we considered to model the variance contributed by gender, brain regions, and genes.

##  Preparations
```{r, size="small"}
suppressPackageStartupMessages({
  require(ggplot2)
  require(formatR)
  require(knitr)
  require(cluster)
  require(factoextra)
  require(dplyr)
  require(RColorBrewer)
  require(clusterProfiler)
  require(org.Hs.eg.db)
  require(enrichplot)
  require(stringr)
  require(forcats)
  require(DOSE)
  require(extrafont)
})

truncated_var <- function(x){
    remove_idx <- c(which.max(x), which.min(x))
    var(x[-remove_idx])
}
wrap_labal <- function(x, width = 60){
    str_wrap(x, width=60)
}
```


```{r}
loadfonts(quiet = T)
setwd("~/data/Results/gtex")
# load("GTEX_l1l2_penalty_13.RData")
# str(fitted_obj)
# attach(fitted_obj)

load("insider_gtex_fitted_object.RData")
str(object)
attach(object)

gender_factor <- cfd_matrices[[1]]
tissue_factor <- cfd_matrices[[2]]
interaction <- cfd_matrices[[3]]

donor_info <- read.csv("meta.csv", stringsAsFactors = F)

load("included_gene_mapping.RData")
ensg_id <- gsub(included_gene_mapping[[1]], pattern="\\.[0-9]+$", replacement="")
meta <- data.frame(ensg_id, included_gene_mapping, stringsAsFactors = F)

cat("Overall age distribution:\n")
print(table(donor_info[,c(3,4)]))
```

## Investigate the difference in BPs between both genders across different brain regions

We considered all metagenes in this analysis. The figure below shows the up-regulated BPs of genes with the greatest positive difference between male and female. 

```{r, fig.height=6, size="small"}
metagene_var <- apply(gender_factor, 2, function(x) abs(x[1] - x[2]))
ord <- order(metagene_var, decreasing = T)

k <- 12
gender_expr_proflies <- gender_factor[, ord[1:k]] %*% column_factor[ord[1:k],]
colnames(gender_expr_proflies) <- colnames(data)

# The first row stands for the male and the second for the female.
diff <- gender_expr_proflies[1, ] - gender_expr_proflies[2, ]

cutoffs <- quantile(diff, probs = seq(0, 1, 0.025))
# selected <- (diff <= cutoffs[2]) # greatest negative difference
selected <- (diff >= cutoffs[length(cutoffs)-1])

upreg <- enrichGO(gene      = unique(meta[selected,1]),
                  OrgDb     = 'org.Hs.eg.db',
                  keyType   = 'ENSEMBL',
                  ont       = "BP",
                  readable  = TRUE)

# summary(upreg)
dotplot(upreg, font.size = 9, showCategory=30, label_format = 60) +
  theme(text=element_text(family="Times New Roman"))
```

The figure below shows the down-regulated BPs of genes with the greatest negative difference between male and female. 

```{r, fig.height=7, size="small"}
k <- 12
gender_expr_proflies <- gender_factor[, ord[1:k]] %*% column_factor[ord[1:k],]
diff <- gender_expr_proflies[1, ] - gender_expr_proflies[2, ]

cutoffs <- quantile(diff, probs = seq(0, 1, 0.025))
selected <- (diff <= cutoffs[2]) # greatest negative difference

downreg <- enrichGO(gene          = unique(meta[selected,1]),
                    OrgDb         = 'org.Hs.eg.db',
                    keyType       = 'ENSEMBL',
                    ont           = "BP",
                    readable      = TRUE)
dotplot(downreg, font.size = 9, showCategory=30, label_format = 60) +
  theme(text=element_text(family="Times New Roman"))
```

## Investigate BPs invloving in the interaction between genders and different brain regions

In the analysis, we explored the BPs of genes showing the difference in the brain region in which there is the greatest difference in correlation between both gender.

```{r, fig.height=6, size="small"}
combinations <- unique(object$confounder)

meta_info <- inner_join(data.frame(SAMPID = row.names(data)), donor_info)
mapping <- cbind(meta_info[,c(3,7)], object$confounder)

distantces <- sapply(seq(13), function(i){
  interaction_idx <- which(combinations[,2] == i)
  selected <- interaction[interaction_idx, ]
  distance <- mean((selected[1, ] - selected[2, ])^2)
  # distance <- cor(selected[1, ], selected[2, ], method = "pearson")
})

idx <- which.max(distantces)
cat("brain region name:", unique(mapping[,c(2,4)])[idx, 1], "\n")
selected <- combinations[which(combinations[,2] == idx),]
```

```{r, fig.height=6, size="small"}
indices <- order(apply(interaction[selected[,3], ], 2, var), decreasing = T)[1:2]
interaction_profiles <- interaction[selected[,3], indices] %*% column_factor[indices,]
diff <- interaction_profiles[1, ] - interaction_profiles[2, ]

cutoffs <- quantile(diff, probs = seq(0, 1, 0.025))
selected_idx <- (diff <= cutoffs[2]) # greatest negative difference

downreg <- enrichGO(gene      = unique(meta[selected_idx,1]),
                    OrgDb       = 'org.Hs.eg.db',
                    keyType     = 'ENSEMBL',
                    ont         = "BP",
                    readable    = TRUE)
dotplot(downreg, font.size = 9, showCategory=30, label_format = 60) +
  theme(text=element_text(family="Times New Roman"))
```

```{r, fig.height=6, size="small"}
# interaction_profiles <- interaction[, ord[1:k]] %*% column_factor[ord[1:k],]
# diff <- interaction_profiles[1, ] - interaction_profiles[2, ]
selected_idx <- (diff >= cutoffs[length(cutoffs)-1])

upreg <- enrichGO(gene       = unique(meta[selected_idx,1]),
                    OrgDb      = 'org.Hs.eg.db',
                    keyType    = 'ENSEMBL',
                    ont        = "BP",
                    readable   = TRUE)
dotplot(upreg, font.size = 9, showCategory=30, label_format = 60) +
  theme(text=element_text(family="Times New Roman"))
```

## metagene characterize the difference in brain function between genders

```{r, fig.height=6, size="small"}
idx <- 11 # ATP systhesis
cutoffs <- quantile(column_factor[idx, ], probs = seq(0, 1, 0.025))
# selected <- (column_factor[idx, ] <= cutoffs[2])
selected <- (column_factor[idx,] >= cutoffs[length(cutoffs)-1]) # greatest negative difference

down_reg <- enrichGO(gene      = unique(meta[selected,1]),
                     OrgDb     = 'org.Hs.eg.db',
                     keyType    = 'ENSEMBL',
                     ont       = "BP",
                     readable  = TRUE)

dotplot(down_reg, font.size = 9, showCategory=30, label_format = 80) +
  theme(text=element_text(family="Times New Roman"))

idx <- 5 # immune related biological processes
cutoffs <- quantile(column_factor[idx, ], probs = seq(0, 1, 0.025))
selected <- (column_factor[idx, ] <= cutoffs[2])
# selected <- (column_factor[idx,] >= cutoffs[length(cutoffs)-1]) # greatest negative difference

down_reg <- enrichGO(gene      = unique(meta[selected,1]),
                     OrgDb     = 'org.Hs.eg.db',
                     keyType    = 'ENSEMBL',
                     ont       = "BP",
                     readable  = TRUE)

dotplot(down_reg, font.size = 9, showCategory=30, label_format = 80) +
  theme(text=element_text(family="Times New Roman"))

idx <- 5 # myelination and gliogenesis
cutoffs <- quantile(column_factor[idx, ], probs = seq(0, 1, 0.025))
# selected <- (column_factor[idx, ] <= cutoffs[2])
selected <- (column_factor[idx,] >= cutoffs[length(cutoffs)-1]) # greatest negative difference

down_reg <- enrichGO(gene      = unique(meta[selected,1]),
                     OrgDb     = 'org.Hs.eg.db',
                     keyType    = 'ENSEMBL',
                     ont       = "BP",
                     readable  = TRUE)

dotplot(down_reg, font.size = 9, showCategory=30, label_format = 80) +
  theme(text=element_text(family="Times New Roman"))
```

## metagene characterize functions of brain regions

```{r, fig.height=6, size="small"}
row.names(tissue_factor) <- unique(mapping[,c(2,4)])[[1]]

idx <- 12 # BPs downregulated in spinal cord (cervical c-1) 
cutoffs <- quantile(column_factor[idx, ], probs = seq(0, 1, 0.025))
# selected <- (column_factor[idx, ] <= cutoffs[2])
selected <- (column_factor[idx,] >= cutoffs[length(cutoffs)-1]) # greatest negative difference

down_reg <- enrichGO(gene      = unique(meta[selected,1]),
                     OrgDb     = 'org.Hs.eg.db',
                     keyType    = 'ENSEMBL',
                     ont       = "BP",
                     readable  = TRUE)

dotplot(down_reg, font.size = 9, showCategory=30, label_format = 80) +
  theme(text=element_text(family="Times New Roman")) 

idx <- 12 # BPs upregulated in spinal cord
cutoffs <- quantile(column_factor[idx, ], probs = seq(0, 1, 0.025))
selected <- (column_factor[idx, ] <= cutoffs[2])
# selected <- (column_factor[idx,] >= cutoffs[length(cutoffs)-1]) # greatest negative difference

down_reg <- enrichGO(gene      = unique(meta[selected,1]),
                     OrgDb     = 'org.Hs.eg.db',
                     keyType    = 'ENSEMBL',
                     ont       = "BP",
                     readable  = TRUE)

dotplot(down_reg, font.size = 9, showCategory=30, label_format = 80) +
  theme(text=element_text(family="Times New Roman"))

idx <- 4 # BPs upregulated in Hypothalamus
cutoffs <- quantile(column_factor[idx, ], probs = seq(0, 1, 0.025))
# selected <- (column_factor[idx, ] <= cutoffs[2])
selected <- (column_factor[idx,] >= cutoffs[length(cutoffs)-1]) # greatest negative difference

down_reg <- enrichGO(gene      = unique(meta[selected,1]),
                     OrgDb     = 'org.Hs.eg.db',
                     keyType    = 'ENSEMBL',
                     ont       = "BP",
                     readable  = TRUE)

dotplot(down_reg, font.size = 9, showCategory=30, label_format = 80) +
  theme(text=element_text(family="Times New Roman")) 

idx <- 6 # BPs upregulated in Hippocampus
cutoffs <- quantile(column_factor[idx, ], probs = seq(0, 1, 0.025))
# selected <- (column_factor[idx, ] <= cutoffs[2])
selected <- (column_factor[idx,] >= cutoffs[length(cutoffs)-1]) # greatest negative difference

down_reg <- enrichGO(gene      = unique(meta[selected,1]),
                     OrgDb     = 'org.Hs.eg.db',
                     keyType    = 'ENSEMBL',
                     ont       = "BP",
                     readable  = TRUE)

dotplot(down_reg, font.size = 9, showCategory=30, label_format = 80) +
  theme(text=element_text(family="Times New Roman")) 

idx <- 8 # BPs upregulated in Cerebellum
cutoffs <- quantile(column_factor[idx, ], probs = seq(0, 1, 0.025))
# selected <- (column_factor[idx, ] <= cutoffs[2])
selected <- (column_factor[idx,] >= cutoffs[length(cutoffs)-1]) # greatest negative difference

down_reg <- enrichGO(gene      = unique(meta[selected,1]),
                     OrgDb     = 'org.Hs.eg.db',
                     keyType    = 'ENSEMBL',
                     ont       = "BP",
                     readable  = TRUE)

dotplot(down_reg, font.size = 9, showCategory=30, label_format = 80) +
  theme(text=element_text(family="Times New Roman"))


idx <- 3 # BPs upregulated in basal ganglia
cutoffs <- quantile(column_factor[idx, ], probs = seq(0, 1, 0.025))
# selected <- (column_factor[idx, ] <= cutoffs[2])
selected <- (column_factor[idx,] >= cutoffs[length(cutoffs)-1]) # greatest negative difference

down_reg <- enrichGO(gene      = unique(meta[selected,1]),
                     OrgDb     = 'org.Hs.eg.db',
                     keyType    = 'ENSEMBL',
                     ont       = "BP",
                     readable  = TRUE)

dotplot(down_reg, font.size = 9, showCategory=30, label_format = 80) +
  theme(text=element_text(family="Times New Roman"))
```