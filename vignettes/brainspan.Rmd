---
title: "Brainspan Data Analysis"
author: "ZHAO Kai"
header-includes:
  - \usepackage{xcolor}
fontsize: 10pt
mainfont: "Times New Roman"
output: pdf_document
---

Here is a brief introduction of analyzing the results of our proposed approach on [Brainspan dataset](www.brainspan.org).

##  Preparations
```{r, size="small"}
suppressPackageStartupMessages({
  require(ggplot2)
  require(formatR)
  require(knitr)
  require(cluster)
  require(factoextra)
  require(dplyr)
  require(RColorBrewer)
  require(clusterProfiler)
  require(org.Hs.eg.db)
  require(enrichplot)
  require(stringr)
  require(forcats)
  require(DOSE)
  require(ggplot2)
  require(hrbrthemes)
  require(viridis)
  require(reshape2)
  require(gridExtra)
  require(extrafont)
})

truncated_var <- function(x){
    remove_idx <- c(which.max(x), which.min(x))
    var(x[-remove_idx])
}
wrap_labal <- function(x, width = 60){ 
    str_wrap(x, width=60)
}
```


```{r, size="small"}
opts_chunk$set(tidy.opts=list(width.cutoff=80),tidy=TRUE)

setwd("~/data/multidimensional_datasets/brainspan_genes_matrix_csv/")
# load results for brain span
load("~/data/Results/brainspan/insider_brainspan_fitted_object.RData")
# load("~/data/Results/brainspan/insider_brainspan_R23_fitted_object.RData")
attach(object) # attach it for easy syntax
str(object) # show the structure of our result

stage_factor <- cfd_matrices[[1]]
tissue_factor <- cfd_matrices[[2]]
# interactions <- cfd_matrices[[3]]

# read meta information
dic <- read.csv("~/data/Results/brainspan/dictionary.csv", stringsAsFactors = F)
# obtain ensemble genes included in our study
load("brainspan_dataset_annotated_fitered.RData")
gene_id <- data.frame(ensembl_gene_id = colnames(data), stringsAsFactors =F)
# match the included genes with meta information
row_meta <- read.csv('rows_metadata.csv', stringsAsFactors = F)
meta <- inner_join(gene_id, row_meta, by = "ensembl_gene_id")

# prepare struture and stage names for naming corresponding latent factors
structure <- unique(dic[,c(6, 9)])
structure <- structure[order(structure[,2]),]
stage <- unique(dic[,c(11, 12)])
r_names <- apply(stage, 1, function(x) paste0(x[2], "_", trimws(x[1])))

# name tissue_factor and stage_factor
rownames(tissue_factor) <- structure[,1]
rownames(stage_factor) <- r_names
```

## Explore development trajectory across entire lifespan

Here we explore the development trajectory with the latent representations of development stage factors. In the below exmaple, we selected the metagene with the largest variation across entire lifespan, visualized the trajectory of this metagene across all development stages, and explore the pathway enriched for top 2.5% genes that contribute to this metagene.

\textcolor{red}{In this part of analysis, I only demonstrate with the metagens with greatest and smallest variance. In order to expand, analysis of other metagenes with a single for loop is fine to generate results.}

```{r, size="small"}
# compute the variance for each metagene
matagene_var <- apply(stage_factor, 2, var)
ord <- order(matagene_var, decreasing = TRUE)
stage_factor[, ord[1:3]]

# use the most variably metagene as an example
metagene_id <- ord[1]
cat("Column_id:", metagene_id, "\n")
```

The plot below show the trajectory of the selected metagene cross all development stages.

```{r, tidy=TRUE, tidy.opts=list(width.cutoff=I(100)), fig.height=5, fig.width=7}
loadfonts(quiet = T)
result <- data.frame(stage = r_names, levels = stage_factor[, metagene_id], stringsAsFactors = F)
result$stage <- factor(r_names, levels = r_names)
# ggplot(data = result, aes(x = stage, y = levels, group = 1)) +
#     geom_line(linetype = "dashed") +
#     geom_point() +
#     xlab("Stages") + ylab("Levels") +
#     theme(plot.title = element_text(size=12, face = "bold", hjust = 0.5), 
#           axis.title.y = element_text(size=10),
#           text=element_text(size=10, family="Times New Roman"), 
#           axis.text.x = element_text(size=10,angle = 45, vjust = 1, hjust=1))
ggplot(data = result, aes(x = stage, y = levels, group = 1)) + 
  scale_color_viridis(discrete = T) + 
  scale_x_discrete(labels=2:14)+
  geom_line() + 
  theme_ipsum(base_family = "Times New Roman", base_size= 14, axis_title_size = 16) + 
  xlab("Stages") + ylab("Levels") 
  #axis.text.x = element_text(size=10,angle = 45, vjust = 1, hjust=1))
```

Then, we investigated the pathway enriched for top 2.5% genes that up-regulates and down-regulates this metagene.

```{r, tidy=TRUE, tidy.opts=list(width.cutoff=I(100)), fig.height=7, size="small"}
cat("Column_id:", metagene_id, "\n")

cutoffs <- quantile(column_factor[metagene_id,], probs = seq(0, 1, 0.025))

# up-regulation, select the highest quantile
selected <- (column_factor[metagene_id,] >= cutoffs[length(cutoffs) - 1]) # 
upreg <- enrichGO(gene = unique(meta[selected,5]),
                  OrgDb = 'org.Hs.eg.db',
                  ont = "BP",
                  readable = TRUE)
dotplot(upreg, font = 9, showCategory=30, label_format = 60) + 
  theme(text=element_text(family="Times New Roman"))

# down-regulation,  select the lowest quantile
selected <- (column_factor[metagene_id,] <= cutoffs[2])
downreg <- enrichGO(gene = unique(meta[selected,5]),
                    OrgDb = 'org.Hs.eg.db',
                    ont = "BP",
                    readable = TRUE)
dotplot(downreg, font = 9, showCategory=30, label_format = 60) + 
  theme(text=element_text(family="Times New Roman"))
```

Then, we explore the metagene with the least variance.

```{r, tidy=TRUE, tidy.opts=list(width.cutoff=I(100)), fig.height=7, size="small"}
# metagene_id <- ord[length(ord)]
metagene_id <- which.min(apply(tissue_factor, 2, function(x) truncated_var(x)))
cat("Column_id:", metagene_id, "\n")

cutoffs <- quantile(column_factor[metagene_id,], probs = seq(0, 1, 0.025))

# up-regulation, select the highest quantile
selected <- (column_factor[metagene_id,] >= cutoffs[2]) 
upreg <- enrichGO(gene = unique(meta[selected,5]),
                   OrgDb = 'org.Hs.eg.db',
                   ont = "BP",
                   readable = TRUE)
dotplot(upreg, font = 9, showCategory=30, label_format = 50) + 
  theme(text=element_text(family="Times New Roman"))
# save(upreg, file = paste0('metagene', metagene_id, 'upreg_dev_pathway.RData'))

# down-regulation, select the lowest quantile
selected <- (column_factor[metagene_id,] <= cutoffs[2]) 
downreg <- enrichGO(gene = unique(meta[selected,5]),
                    OrgDb = 'org.Hs.eg.db',
                    ont = "BP",
                    readable = TRUE)
dotplot(downreg, font = 9, showCategory=30, label_format = 50) +
  theme(text=element_text(family="Times New Roman"))
```


```{r tidy=TRUE, tidy.opts=list(width.cutoff=I(100)), fig.width= 10, fig.height=4}
metagene_id <- ord[1]
gene_order <- order(column_factor[metagene_id,], decreasing = TRUE)
selected_genes <- gene_id[gene_order[1:5],]
col_ids <- sapply(selected_genes, function(x) which(meta[[1]] == x))

stage_profiles <- stage_factor %*% column_factor
selected <- stage_profiles[,col_ids]
colnames(selected) <- meta[[4]][col_ids]
rownames(selected) <- r_names
result1 <- melt(selected[,-c(1,2)])
colnames(result1) <- c("Stage", "Gene", "Levels")
result1$Stage <- factor(r_names, levels = r_names)

selected_genes <- gene_id[gene_order[(length(gene_order)-4):length(gene_order)],]
col_ids <- sapply(selected_genes, function(x) which(meta[[1]] == x))

selected <- stage_profiles[,col_ids]
colnames(selected) <- meta[[4]][col_ids]
rownames(selected) <- r_names
result2 <- melt(selected[,-c(1,4)])
colnames(result2) <- c("Stage", "Gene", "Levels")
result2$Stage <- factor(r_names, levels = r_names)

p1 <- ggplot(data = result1, aes(x=Stage, y=Levels, group = Gene, color=Gene)) +
    xlab("Stages") + ylab("Levels")+
    scale_color_viridis(discrete = TRUE) +
    geom_line(size=1) +
    ggtitle("Trajectories of top up-regulated genes") +
    theme_ipsum(base_family = "Times New Roman", base_size= 12, axis_title_size = 14, plot_title_size = 16) +
    theme(plot.margin = unit(c(5, 2, 5, 2), "pt"))+
    scale_x_discrete(labels=2:14)

p2 <- ggplot(data = result2, aes(x=Stage, y=Levels, group = Gene, color=Gene)) +
    xlab("Stages") + ylab("Levels")+
    scale_color_viridis(discrete = TRUE) +
    geom_line(size=1) +
    ggtitle("Trajectories of top down-regulated genes") +
    theme_ipsum(base_family = "Times New Roman", base_size= 12, axis_title_size = 14, plot_title_size = 16) +
    theme(plot.margin = unit(c(5, 2, 5, 2), "pt"))+
    scale_x_discrete(labels=2:14)

grid.arrange(p1, p2, ncol=2) 
```


## Explore pathways that contribute to the brain structure development
First, we obtain general expression profiles for different tissues, and analyze the functional pathways for each tissue. 

\textcolor{red}{In this part of analysis, I only demonstrate with the second tissue. In order to expand, analysis of other metagenes with a single for loop is fine to generate results for all tissues.}

```{r, tidy=TRUE, tidy.opts=list(width.cutoff=I(120)), fig.height=7, size="small"}
# tissue_matrix <- tissue_factor[,-c(14)] %*% column_factor[-c(14),]
tissue_matrix <- tissue_factor %*% column_factor
rownames(tissue_matrix) <- rownames(tissue_factor)

# use the second brain region as example
tissue_id <- 2
cat("Tissue name:", rownames(tissue_factor)[tissue_id], "\n")
cutoffs <- quantile(tissue_matrix[tissue_id,], probs = seq(0, 1, 0.025))

# up_regulation, select the highest quantile
selected <- (tissue_matrix[tissue_id,] >= cutoffs[length(cutoffs) - 1]) 
upreg <- enrichGO(gene = unique(meta[selected,5]),
                  OrgDb = 'org.Hs.eg.db',
                  ont = "BP",
                  readable = TRUE)
# result <- data.frame(upreg)
dotplot(upreg, font = 9, showCategory=30, label_format = 60) + 
  theme(text=element_text(family="Times New Roman"))

# down-regulation, select the lowest quantile
selected <- (tissue_matrix[tissue_id,] <= cutoffs[2]) 
downreg <- enrichGO(gene = unique(meta[selected,5]),
                    OrgDb = 'org.Hs.eg.db',
                    ont = "BP",
                    readable = TRUE)
dotplot(downreg, font = 9, showCategory=30, label_format = 60) + 
  theme(text=element_text(family="Times New Roman"))
```


```{r}
m <- c( "average", "single", "complete", "ward")
names(m) <- c( "average", "single", "complete", "ward")

# function to compute coefficient
ac <- function(x) {
  agnes(tissue_factor, method = x)$ac
}
ac_vec <- sapply(m, function(x) ac(x))
ac_vec

hc3 <- agnes(tissue_factor, method = unname(m[which(ac_vec == max(ac_vec))]))
pltree(hc3, cex = 0.6, hang = -1, main = "Dendrogram of tissue representations")
```
Second, we explore the pathways that contribute the most to the expression difference across different brain structures. This analysis can identify biological processes that partially contribute to the difference across different brain structures.

\textcolor{red}{The second kind of analysis only can partial explain the pathways that signal differently across all tissues in our study, so expanding it with other two or three metagenes with high variance is enough.}

```{r, tidy=TRUE, tidy.opts=list(width.cutoff=I(120)), fig.height=7, size="small"}
# tiss_var <- apply(tissue_factor, 2, var)
tiss_var <- apply(tissue_factor, 2, function(x) truncated_var(x))

metagene_id <- which.max(tiss_var)
cat("Column_id:", metagene_id, "\n")

cutoffs <- quantile(column_factor[metagene_id,], probs = seq(0, 1, 0.025))

# up-regulation, select the highest quantile
selected <- (column_factor[metagene_id,] >= cutoffs[length(cutoffs) - 1]) 
upreg <- enrichGO(gene = unique(meta[selected,5]),
                  OrgDb = 'org.Hs.eg.db',
                  ont = "BP",
                  readable = TRUE)
dotplot(upreg, font = 9, showCategory=30, label_format = 60) + 
  theme(text=element_text(family="Times New Roman"))
```

